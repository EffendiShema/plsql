-- Monthly revenue per region
WITH monthly_sales AS (
    SELECT
        c.region,
        DATE_FORMAT(t.transaction_date, '%Y-%m-01') AS month_start,
        SUM(t.amount) AS monthly_amount
    FROM transactions t
    JOIN customers c
        ON t.customer_id = c.customer_id
    GROUP BY
        c.region,
        DATE_FORMAT(t.transaction_date, '%Y-%m-01')
)
SELECT
    region,
    month_start,
    monthly_amount,
    -- Running total (ROWS frame)
    SUM(monthly_amount) OVER (
        PARTITION BY region
        ORDER BY month_start
        ROWS BETWEEN UNBOUNDED PRECEDING AND CURRENT ROW
    ) AS running_total_rows,
    -- 3-month moving average (ROWS frame)
    AVG(monthly_amount) OVER (
        PARTITION BY region
        ORDER BY month_start
        ROWS BETWEEN 2 PRECEDING AND CURRENT ROW
    ) AS moving_avg_3m_rows,
    -- Max over all months in that region (RANGE frame often same as default here)
    MAX(monthly_amount) OVER (
        PARTITION BY region
        ORDER BY month_start
        RANGE BETWEEN UNBOUNDED PRECEDING AND CURRENT ROW
    ) AS max_so_far
FROM monthly_sales
ORDER BY
    region,
    month_start;
